<?php

// Check GenBak accession numbers

error_reporting(E_ALL);

$api_key = '56b7d0c702af1e3fa9e863c48a53cfc89b09';

///----------------------------------------------------------------------------------------
function get($url, $content_type = '')
{	
	$data = null;

	$opts = array(
	  CURLOPT_URL =>$url,
	  CURLOPT_FOLLOWLOCATION => TRUE,
	  CURLOPT_RETURNTRANSFER => TRUE,
	  
	  CURLOPT_SSL_VERIFYHOST=> FALSE,
	  CURLOPT_SSL_VERIFYPEER=> FALSE,
	  
	);

	if ($content_type != '')
	{
		$opts[CURLOPT_HTTPHEADER] = array(
			"Accept: " . $content_type 
		);		
	}
	
	$ch = curl_init();
	curl_setopt_array($ch, $opts);
	$data = curl_exec($ch);
	$info = curl_getinfo($ch); 
	curl_close($ch);
	
	return $data;
}

//----------------------------------------------------------------------------------------
// Given a list of accession numbers, try and match
function accession_to_gi($ids)
{
	global $api_key;
	
	$parameters = array(
		'db' 		=> 'nucleotide',
		'retmode' 	=> 'json',
		'id' 		=> join(",", $ids),
		'api_key'	=> $api_key	
	);
	
	$url = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?' . http_build_query($parameters);
	
	// echo $url . "\n";
		
	$json = get($url);
	
	// echo $json;
	
	$obj = json_decode($json);
	
	// print_r($obj);	
	
	$result = array();
	
	foreach ($ids as $accession)
	{
		$result[$accession] = 0;
	}
	
	foreach ($obj->result as $k => $v)
	{
		switch ($k)
		{
			case 'uids':
				break;
				
			default:
				$match = $v->accessionversion;
				
				// echo $v->accessionversion . "\n";
				
				if (isset($result[$match]))
				{
					$result[$match] = $k;
				}
				else
				{
					$match = preg_replace('/\.\d$/', '', $match);
					
					if (isset($result[$match]))
					{
						$result[$match] = $k;
					}
					else
					{
						// last gasp, sometimes identifier is a LOCUS not an accession,
						// e.g. https://www.ncbi.nlm.nih.gov/nuccore/AONU00000000.1/
						
						if (isset($v->extra))
						{
							$extra = explode("|", $v->extra);
							foreach ($extra as $label)
							{
								if (isset($result[$label]))
								{
									$match = $label;
									$result[$match] = $k;
								}							
							}
						}
					}
				}
				
				// echo $match . "\n";
				
				break;		
		}
	}
	
	return $result;
	
}


//----------------------------------------------------------------------------------------

$accessions = array(

'OU744360.1',
'AONU01000000',
'CTS12675',
'DK60521',
'AC016822.1',
'WI188344',
'CD000494',
'CP002213.1',
'EU784198',
'AMD3100',
'KIZ96180',
'YMV080',
'A3574',
'T830.1',
'BE2020764',
'GGI12538',
'RE62031',
'CD004152',
'MBS281148',
'MK226160',
'U1601227',
'CD004022',
'JWLS01000000',
'U55237',
'SAAP159',
'KX682236.1',
'KJ493406',
'CD006001',
'DA11190',
'KIAA0101',
'BKJ473816',
'KY417152',
'KJ801617',
'SH30396',
'MZ054380',
'MN737509',
'//cardio.jmir.org/2020/1/e15885/ In',
'APP1138855',
'SWAT002012',
'KF666477',
'CD008204',
'ATI20208.1',
'AK133540',
'H6831',
'ON959566',
'SRP161123',
'SRR849502',
'MK838103',
'DRA001129',
'CR00240703',
'FR374455',
'FR401275',
'MNZ1050',
'M74849',
'I0260',
'V900502',
'M29279.1',
'QE09050',
'E3918',
'AR060782',
'DQ176',
'CD007554',
'BG094499',
'ACJ13096',
'SRR1598823',
'AF189712',
'SRR11517301',
'KIZ820280',
'HMC03397',
'MB809218',
'EU022525',
'MON15985',
'KT781346',
'MK928503',
'MH447996',
'MW203026',
'D456',
'MW355420.1',
'ABB58751.1',
'MB833634',
'JCI135953',
'KIZ016072',
'BJ5183',
'BK2016157',
'KM462865',
'CIHR66975',
'OD010440',
'OJ190653',
'IC486051',
'AAA72321.1',
'KP966108',
'KF156890',
'GZ070',
'DQ854809',
'G090084',
'B6013',
'BX50',
'ONCO12152',
'KP900335',
'R115777',
'CA150416.1',
'A12379',
'GM07215',
'CRD42021227967',
'M633460',
'GB003545',
'ISA2020101',
'MF687050',
'ALA190015',
'PMC4016112',
'CD001141',
'CU12102021369',
'G19833',
'FJ872593',
'MDL12330',
'MH170472',
'FI10386',
'FJ754270',
'E007.0',
'FJ705359.1',
'NS065741',
'//www.ncbi.nlm.nih.gov/nuccore/MF074325.1',
'GU321192',
'PJ015002',
'KY435824.1',
'MH617689',
'CD000543',
'AYW8000',
'//digital.nhs.uk/catalogue/PUB19124',
'AI30627',
'I2959',
'KK4832',
'JQ692589',
'JQ314225',
'CRD42013004473',
'MT524969',
'A10011',
'AC002400',
'CBP60946',
'X67288',
'CD000195',
'OM892146',
'PMC7654800',
'IN220621',
'MDS28303',
'APVO436',
'L2016003',
'SRR495445',
'ATCC43504',
'MF162298',
'Y21026',
'U63644',
'A26941',
'KK101383',
'KT314339',
'NCC2461',
'RG7388',
'A05033',
'CD001127',
'CA77598',
'CRD42016037842',
'CD006469',
'MW306452',
'MG746968',
'BOP022177',
'KY778910',
'CAC35733.1',
'SZXK2020089',
'CD000409',
'ERX5039984',
'SRR5986337',
'MN090886',
'AY116636.1',
'SH20191204',
'//sgp.fas.org/crs/row/RL33534.pdf',
'MT395646',
'C234',
'AF190696.1',
'R17079',
'BT043907',
'CD000425',
'POX02086',
'CD003196',
'DQ597960',
'KM244708',
'LS02109',
'PMC6037338',
'EY019007',
'LW20211104',
'AAB09252',
'KDO61571',
'K15280',
'VE14188',
'CP009912',
'B10697',
'LY2874455',
'U2609',
'CYB22096',
'LY3012207',
'CRD42018108242',
'MG557852',
'A16064',
'AB181991',
'E3290',
'OP837957',
'AAC36131.1',
'GM47892',
'FN545816',
'GNT1160011',
'KJ012021097',
'SR500644',
'MZ040126',
'ANJ02325',
'KM095047',
'CP014065.1',
'PMC7072100',
'MH62480',
'CA164048',
'HM566246',
'FJ536664.1',
'AF041382',
'GM007281',
'L08707',
'CA143858',
'PMC6213024',
'AC010768',
'JF505444',
'MW714845',
'CA016059',
'U2413',
'M6700',
'AID1159554',
'KU748488',
'VU0456940',
'BLF00793',
'EZ139653',
'CD010825',
'T001674',
'CRD136855',
'EU039976',
'CFBP6276',
'AST2818',
'EZ140395',
'F7378',
'U1530402',
'AAM10624.1',
'MB6186',
'CD000222',
'//go.drugbank.com/drugs/DB01224',
'PMC3491474',
'GSK9089',
'T3610',
'SRX3825309',
'GU219830',
'DS002',
'J510050002',
'U94848.1',
'CA174292',
'H2575',
'AC0790305',
'KM249869',
'MN708024',
'AAW21319.1',
'E21534',
'D12492',
'CA197292',
'K02027',
'CRD42017081499',
'EY014375',
'AY903460',
'AAO42816.1',
'KP793008',
'EAAX5751',
'AP09260233',
'LY2886721',
'PSP412627',
'CD005468',
'APP1116690',
'SRP010680',
'EY027881',
'ISO17025',
'FJ900084',
'HG4719',
'COG0457',
'BC1000',
'HH12000000',
'U89652',
'R5470',
'IN62330',
'U588655',
'MW415419',
'APP2008433',
'CV12472',
'AA026302',
'E0771',
'KP233805',
'PMC98986',
'X16280.1',
'EWSOGP2',
'JF338863',
'AF414403',
'NQ103',
'D03211',
'YJB12407',
'HTX019',
'ABI20696',
'M2496',
'CD001541',
'PA4681',
'CD0000020000',
'DCAR000385',
'GBU45',
'MA0688.1',
'IMI349061',
'AB477465',
'LC477217.1',
'IRP201550',
'OM18370',
'GCTCV218',
'LC635748',
'BQ2307',
'AAK57435',
'KP723514',
'SU6656',
'CA176058',
'CA176843',
'H20050325',
'MW338733',
'ISCW024393',
'CP002824',
'AZD9291',
'AL111168.1',
'AI429910',
'B49197',
'BC095225',
'U12171.1',
'HTCC1062',
'MGC138688',
'CP000233.1',
'JQ751115',
'L17806',
'E6212',
'KX985971',
'EU266762',
'HL147126',
'LC215566',
'IMI58289',
'AR057347',
'M36008',
'LSP920',
'GQ902038',
'C105',
'AK146144',
'ATCC49145',
'BU038044',
'SPA14264',
'PLB12730',
'A25576',
'EF649783',
'MZ823408',
'L2014071',
'HM183083',
'G0800081',
'AR073172',
'L404456',
'HJB14850',
'CD008986',
'ERR232253',
'PICPI23223',
'MA02142',
'X78226',
'//www.lanacion.com.ar/el-mundo/ops-advierten-que-estan-circulando-vacunas-falsas-en-la-argentina-nid21042021/',
'HL085143',
'S64152',
'//www.nature.com/articles/nature22989',
'U123092724',
'AG054349',
'C10338',
'S25538',
'KC157741',
'BC168687',
'SCH58261',
'DQ829781',
'CH5424802',
'JQ683232',
'KF137640',
'LDEC011287',
'DA046487',
'SRX1053794',
'E4359',
'DT896093',
'ACG6814',
'AEG93832.1',
'BX001595',
'CA072649',
'JX080201',
'PMC5634782',
'MT559995',
'AP019714',
'GU131902',
'DA029325',
'D17763',
'C6628',
'HL122513',
'MN882787',
'JD5037',
'MGN1703',
'IN100415',
'PMC7578581',
'COBI13209',
'OTU15713',
'PMC7356035',
'MU30925',
'//www.ebi.ac.uk/ena/data/view/ERX352930',
'AY686763',
'JF807307',
'AM398200',
'ECE35753',
'MH220844',
'K02566',
'AB122080',
'B20310019',
'GU324757',
'YXKC2020004',
'GER4601',
'A32959',
'BK20160157',
'KX574908',
'JCMM14604',
'EPR12763',
'ABC50099.1',
'EU974548',
'NR042975',
'C10499',
'VFG016286',
'HD217675',
'GW4064',
'HQ398877',
'HM05157',
'BGC0000012',
'//www.nature.com/articles/d41586-021-00998-w',
'A021501',
'JN695777',
'QTPC104',
'X59604',
'KM496323',
'VCC251801',
'FJ554588',
'TSG101',
'CD003162',
'ATCC43255',
'TCA13121',
'HQ717160',
'LY2510924',
'KP280068',
'HB0801',
'AY084033',
'CAY10560',
'M67473',
'K112629',
'//www.fao.org/3/ca5162en/ca5162en.pdf',
'BF1704499',
'KY007095',
'NCU01312',
'PA3203',
'FT27997',
'AB509823',
'U22378',
'G1780',
'AA011999',
'AB016387.1',
'ADP136823',
'JCC24318',
'EU622908.1',
'EMP212691',
'AE001575',
'PG5801',
'ATCQ01738',
'SRR11781640',
'R22726',
'HL142809',
'HKL2000',
'XDB29020000',
'MZ130275',
'KP308453',
'SRR8369176',
'ADP100358',
'FJ874775',
'CRD42020198267',
'AI155453',
'C34554',
'DQ072672.1',
'DC012760',
'PMC319979',
'C10310',
'JPST001178',
'AF368330',
'EVA13429',
'Y2765',
'V13241',
'KP185121',
'JP26114003',
'MK905708',
'HL7702',
'CA118770',
'AB701701',
'KIP75788.1',
'CA096832',
'HL094585',
'LN484108.1',
'T7660',
'AF043303',
'FG454048',
'AY084031',
'MT321108',
'CX6258',
'PHA03247',
'GX070060',
'BAAU01000008',
'AID53183.1',
'MG719834',
'SRR6664724',
'ERP000635',
'ABX82864.1',
'BRB31665',
'AI01644',
'NS085517',
'N69830',
'JNS101568',
'ACE80209',
'EU677200',
'ADJ64487.1',
'CS0273',
'ATCC29906',
'MZ314132',
'EC170302',
'H2975',
'MH070289',
'MG752876',
'E10990',
'EB019980',
'CASE21463',
'CD005967',
'AB024492',
'F900',
'AAK51718',
'AF201684',
'RP120380',
'TPS5098',
'DK050277',
'A1007001',
'SRR1174242',
'PMC4840777',
'KX20180109',
'KT876881',
'GM109899',
'OM455402',
'AL807742.1',
'KT266713',
'MEN13583',
'CA21239',
'KRN5500',
'BX7375',
'JNS111916',
'EC6135',
'A438079',
'FJ613420',
'SRP253455',
'SRP202053',
'MH547308',
'KR003784.1',
'PD166866',
'MF19',
'MK687405',
'TPS8576',
'HL090804',
'DNL201911',
'CD009437',
'HL074409',
'A601888',
'FJ748892',
'PMC6381280',
'//www.lrrd.org/lrrd23/2/meng23037.htm',
'TP329176',
'CASE21372',
'ABU68481',
'N9741',
'YWL3056',
'KM058748',
'GC221279',
'A09106',
'SR502040',
'CA163890',
'H415',
'MBS652918',
'OTX015',
'U1304617',
'KC460325',
'JNS172141',
'T59127',
'C81040',
'CP003342.1',
'M7292',
'AR059103',
'SRR7880408',
'PAB0423',
'JNS203045',
'BAA88237',
'QLP89119.1',
'HE978501',
'RPDG01000000',
'CNY23',
'CD007182',
'MT017566',
'AF203481',
'AA7075',
'AY508694',
'F25707939',
'KX845687',
'CNV2197944',
'NS1619',
'MW036243',
'AL512625.3',
'DK122811',
'KY629911',
'NBP2451590',
'DBVPG5303',
'CHARMM27',
'KX697599',
'CDD13120',
'JOH212049',
'DV692405',
'E0282',
'A9282',
'DE013513',
'JQ060592',
'G03013',
'G0301067',
'SRX833917',
'LT592159.1',
'ST15925',
'JN714124',
'ATCC700794',
'KJ363319',
'CA140388',
'IC486241',
'U63955',
'ADZ0530',
'DK45462',
'AM10340',
'AI036629',
'K104656',
'SRX020602',
'FJ900089',
'M190062',
'KC420278',
'CCR31819',
'TQ8040',
'JX218218',
'KF588709',
'//www.ncbi.nlm.nih.gov/sra/SRX2701518',
'CD005415',
'TIO2008014',
'AC104809',
'BK20170367',
'CD009149',
'LM009722',
'SH30071.03',
'J000075',
'AF201874',
'HT110216',
'KY399850',
'SKF82958',
'SRP170808',
'PCAM3011',
'GQ859163',
'CD005080',
'B24408',
'HL70279',
'RM20894',
'LT618780',
'//files.eric.ed.gov/fulltext/ED562408.pdf',
'MUS26875',
'OUV2500',
'FEG200',
'A31570',
'KC218482',
'CA159868',
'WCP307',
'JX844716.1',
'JL616468',
'XYL18013',
'AX741144',
'AM183330',
'MG828823',
'HM015878',
'LSKCD150',
'MG845553',
'PA4201',
'KY348776',
'SRP064925',
'AI152881',
'Y201534400',
'KT370088',
'AI022763',
'TP2015037',
'CD006982',
'L08705',
'GM58643',
'HD069746',
'MH125069',
'ADC95435.1',
'PMC4948566',
'CECT7765',
'CB1954',
'YC29974',
'KU757057',
'AG061853',
'DK075787',
'DTY168',
'AJT14642',
'PD150606',
'APP1174555',
'AY585228.1',
'AF3204',
'GSK2126458',
'HMAS242639',
'E7600',
'SRR14140256',
'DK121146',
'//www.ncbi.nlm.nih.gov/nuccore/KF766114',
'LB80380',
'CD003518',
'NSC119893',
'AAG31173.1',
'CD009855',
'AG18031',
'DQ460711.1',
'KC283025',
'GM079154',
'CA174841',
'TP760318',
'IPS8800',
'HL133964',
'SRR11241614',
'KY923066',
'JQ060578',
'CCR35519',
'PMC3668617',
'CAB06783.1',
'PMC5579045',
'AI070218',
'EU384622',
'APP1175047',
'CD001163',
'MW647236',
'MR1709310',
'OD010939',
'PMC6599195',
'FT130101709',
'MBS458138',
'T5648',
'KC776075',
'JK2012049',
'CD004749',
'FJ542675',
'FJ859185',
'AI075039',
'//www.fao.org/docrep/014/i2426e/i2426e00.pdf',
'HQ009809',
'CFAP45',
'DE024971',
'DQ507218',
'D1055',
'MB805349',
'AF298213',
'JNS132507',
'M662306',
'//www.reuters.com/article/idUSFit987186',
'TJP12127',
'KM201710025007',
'M7175',
'MMV665941',
'BOR5537',
'MH065215',
'CD002120',
'CD014963',
'//www.fao.org/docrep/010/a0701e/a0701e00.HTM',
'JNS081161',
'PMC6375921',
'MP07007',
'C00609',
'CRD42019125245',
'AI069219',
'C04037',
'DP21010325',
'FJ10357',
'MQZX01000000',
'EY007102',
'LC413847',
'AF130033',
'KM875729.1',
'FSH03878',
'ELME000145',
'GA10790',
'JW0716',
'PMC8013587',
'CD004072',
'JN129834',
'EGZ09677',
'BLF01938',
'MG735675',
'CD011577',
'F3506',
'DQ201553',
'ET713388',
'SRR6144056',
'AAA87603',
'IPVH00010',
'GU815099',
'SR95531',
'LC341552',
'SRR3743195',
'HC067047',
'GQ221887',
'PJ015053',
'CA62924',
'MT14984',
'AF155928',
'CA17111',
'LA1230314',
'ERR6688654',
'MT497284',
'CECT7480',
'CP073717.1',
'IN222420',
'AJ005044',
'SSA0255',
'CA228631',
'KT161261',
'AY392151',
'DQ886273',
'CP035466',
'S42303',
'BF2016702',
'L16765',
'D1354',
'EF423897',
'AP001918',
'MF693403.1',
'U86600.1',
'NS050437',
'MH707374',
'CA15117',
'GV248',
'ANW37921.1',
'//www.nsf.gov/pubs/2017/nsf17542/nsf17542.htm',
'MG781191',
'KT966498',
'MG924929',
'FR2000163',
'LJ200913',
'OM489534',
'AA092254',
'MT586806',
'AWUT01000000',
'UCF803024',
'M0298',
'ON123300',
'FB0875714',
'PBC28962',
'DB00758',
'STRM304',
'MN812494',
'CG816569',
'FJ024300',
'BAB83795',
'MH086690',
'KP636627',
'OL874968',
'CA133027',
'T7279',
'CD005228',
'C144',
'E2505',
'EH000534',
'MW862792',
'GBW10015',
'AY506529',
'AF423193',
'PMC2811436',
'BA170606',
'CYB22058',
'AY387595.2',
'ICI174864',
'CD005992',
'JQ0042791',
'ABI7500',
'GU253733',
'HI9125',
'ISO15189',
'C153',
'SAR302503',
'NC9560650',
'ZR201910250090',
'D9108',
'CD011490',
'WAT054955',
'J00475',
'PC00227',
'ERR188479',
'J3215',
'FMT4000',
'HL145228',
'KF720713',
'SRX4003562',
'RP170259',
'DAN00213',
'BAE87051.1',
'DK110399',
'KP793050',
'CP2305',
'DL0010443',
'GQ402491',
'CD009095',
'AI106697',
'NS061952',
'E2520',
'CGP58845',
'AC100810.1',
'CGP35384',
'DK32520',
'CD013308',
'E386',
'RGFP966',
'GBM8401',
'EUA203174',
'MT682939',
'FJ469626',
'RD832720',
'D12451',
'VUF10661',
'UHDB31',
'CD011261',
'JCI19628',
'CTR5000',
'R518',
'CCFM1025',
'JF683498',
'OV6948',
'DFC450',
'R2000',
'MK515139',
'NAU24374',
'BC100466',
'MVZ190762',
'MH430882',
'WS1948310',
'SRX1506532',
'AY330503',
'SRP128680',
'MG189641',
'AY372521',
'EU982198',
'EOY29346.1',
'RD83382501',
'GQ214539',
'FJ231992',
'AE000790',
'A2020190',
'SYZ66198',
'G6817',
'PMC6679805',
'AE009948',
'A2022288',
'FZ2020023',
'FJ455842.2',
'AB19259010',
'XZ0906',
'A5649',
'CD012663',
'AI114575',
'AL031587.1',
'KJ956388',
'A11036',
'CP046618.1',
'MVZ190868',
'U1808209',
'KF427915',
'A72',
'KF796625',
'PHY212888',
'KU0063794',
'U50488',
'L34971',
'NSC74859',
'PMC6374994',
'A10042',
'K164',
'CD000058',
);

$chunks = array_chunk($accessions, 10);

$start 	= 0;
$end 	= 1;
$end 	= count($chunks);

$count = 1;

for ($i = $start; $i < $end; $i++)
{	
	// print_r($chunks[$i]);

	$result = accession_to_gi($chunks[$i]);
	
	// print_r($result);
	
	foreach ($result as $k => $v)
	{
		echo 'INSERT OR IGNORE INTO gi(subjId, gi) VALUES("' . $k . '", ' . $v . ');' . "\n";
	}
	
	if (($count++ % 5) == 0)
	{
		$rand = rand(1000000, 3000000);
		echo "\n-- ...sleeping for " . round(($rand / 1000000),2) . ' seconds' . "\n\n";
		usleep($rand);
	}
	
}


?>
